/*******************************************************************************************************************************//**
 *
 * @file		TimerSystick.c
 * @proyect		TPO_Lpc_845_Project
 * @date		09:30:01
 * @author		Velazquez Lautaro
 * @subject		INFO II
 * @course		R2051
 *
 **********************************************************************************************************************************/


/***********************************************************************************************************************************
 *** INCLUDES
 **********************************************************************************************************************************/

#include "TimerSystick.h"
#include <clock_config.h>

/***********************************************************************************************************************************
 *** DEFINES PRIVADOS AL MODULO
 **********************************************************************************************************************************/



/***********************************************************************************************************************************
 *** MACROS PRIVADAS AL MODULO
 **********************************************************************************************************************************/



/***********************************************************************************************************************************
 *** TIPOS DE DATOS PRIVADOS AL MODULO
 **********************************************************************************************************************************/



/***********************************************************************************************************************************
 *** TABLAS PRIVADAS AL MODULO
 **********************************************************************************************************************************/



/***********************************************************************************************************************************
 *** VARIABLES GLOBALES PUBLICAS
 **********************************************************************************************************************************/



/***********************************************************************************************************************************
 *** VARIABLES GLOBLES PRIVADAS AL MODULO
 **********************************************************************************************************************************/

static uint32_t tick = 0;

typedef struct	timer
{
	tiempo _valor;
	tiempo _valorRecarga;
	timer_types _tipo;
	bool _timerFinalizo;
	void (*_handler)(void);
}Timer;

static Timer dataTimer[TIMER_MAX];

/***********************************************************************************************************************************
 *** PROTOTIPO DE FUNCIONES PRIVADAS AL MODULO
 **********************************************************************************************************************************/



/***********************************************************************************************************************************
*** CONFIGURACION DE ERRORES
**********************************************************************************************************************************/



/*--------------------------------------------------------------------------------------------------------------------------------*/

/***********************************************************************************************************************************
 *** IMPLEMENTACION DE FUNCIONES PUBLICAS
 **********************************************************************************************************************************/

void SysTick_Handler(void)
{
	tick++;
}

void 	TIMER_Systick_Init(void)
{
	SysTick_Config(((SystemCoreClock/1000)*1)-1);	//Periodo de 1ms
}

void	TIMER_Start(timer_id id, tiempo valor, timer_types tipo ,void (*handler)(void))
{
	if(id < TIMER_MAX)
	{
		dataTimer[id]._valor = valor;
		dataTimer[id]._tipo = tipo;
		dataTimer[id]._timerFinalizo = false;

		if(tipo == PERIODIC)
		{
			dataTimer[id]._valorRecarga = valor;
		}
		else
		{
			dataTimer[id]._valorRecarga = 0;
		}
	}
}

void 	TIMER_Stop(timer_id id)
{
	dataTimer[id]._valor = 0;
	dataTimer[id]._timerFinalizo = false;
	dataTimer[id]._handler = NULL;
}

bool 	TIMER_Get_Event(timer_id id)
{
	bool retVal = dataTimer[id]._timerFinalizo;
	dataTimer[id]._timerFinalizo = false;
	return retVal;
}

void TIMER_ProcessEvent(void)
{
	if(tick > 0)
	{
		/*Paso un 1ms*/
		tick--;
		for(int i = 0; i < TIMER_MAX; i++)
		{
			if(dataTimer[i]._valor > 0)
			{
				dataTimer[i]._valor--;
				if(dataTimer[i]._valor == 0)
				{
					//Ya paso el tiempo
					dataTimer[i]._timerFinalizo = true;
					if(dataTimer[i]._handler != NULL)
					{
						dataTimer[i]._handler();
					}
					dataTimer[i]._valor = dataTimer[i]._valorRecarga;
				}
			}
		}
	}
}

/***********************************************************************************************************************************
 *** IMPLEMNTACION DE FUNCIONES PRIVADAS AL MODULO
 **********************************************************************************************************************************/



/*--------------------------------------------------------------------------------------------------------------------------------*/
